import{a as e,u as a}from"./router-B4-DsX-D.js";import{I as l,_ as t,u as s,g as o,c as n,k as i,C as d,s as c,S as u,M as r}from"./index-i9U3HkMI.js";import{G as p,D as g,C as v,A as m,L as _,M as h,r as k,c as w,o as y,w as f,z as b,B as C,u as I,P as S,f as B,b as T,n as x,I as L,F as M,O as j,R as F,S as K,V as H,W as D,X as O,Y as A}from"./vue-core-Bj9NSyid.js";import{H as $}from"./highlight-C7QV_n3L.js";import{u as E}from"./i18n-Cs-aH8_I.js";import{m as z}from"./marked-txETn4SA.js";import"./state-B_8nituZ.js";import"./vendor-CJNHjaSW.js";import"./mock-CWrnY2TL.js";const P=Object.assign({name:"CopyIcon"},{__name:"CopyIcon",setup:e=>(e,a)=>(g(),p(l,_(h(e.$attrs)),{default:v((()=>a[0]||(a[0]=[m("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"},null,-1),m("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"},null,-1)]))),_:1},16))}),V=t(Object.assign({name:"LoadingIcon"},{__name:"LoadingIcon",setup:e=>(e,a)=>(g(),p(l,_(h(e.$attrs)),{default:v((()=>a[0]||(a[0]=[m("circle",{cx:"12",cy:"12",r:"10",class:"loading-circle"},null,-1),m("path",{class:"loading-path",d:"M12 2a10 10 0 0 1 10 10"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-91a0c3ed"]]),U=t(Object.assign({name:"ScrollToBottomIcon"},{__name:"ScrollToBottomIcon",setup:e=>(e,a)=>(g(),p(l,_(h(e.$attrs)),{default:v((()=>a[0]||(a[0]=[m("polyline",{points:"6 9 12 15 18 9","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-58f52f69"]]),R=t(Object.assign({name:"CopyCodeIcon"},{__name:"CopyCodeIcon",setup:e=>(e,a)=>(g(),p(l,_(h(e.$attrs)),{default:v((()=>a[0]||(a[0]=[m("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"},null,-1),m("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-e90347b2"]]),J=t(Object.assign({name:"CheckIcon"},{__name:"CheckIcon",setup:e=>(e,a)=>(g(),p(l,_(h(e.$attrs)),{default:v((()=>a[0]||(a[0]=[m("polyline",{points:"20 6 9 17 4 12"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-75117b05"]]),q={class:"code-block"},G={class:"code-header"},N={class:"code-language"},W={class:"code-actions"},X=["title"],Y={class:"code-content"},Q=t(Object.assign({name:"程式碼區塊"},{__name:"CodeBlock",props:{content:{type:String,required:!0,default:""},language:{type:String,default:"javascript"}},setup(e){const{t:a}=E(),l=e=>a(`main.${e}`),t=e,s=k(null),o=k(!1),n=w((()=>o.value?l("copied"):l("copyCode"))),i=w((()=>({js:"JavaScript",javascript:"JavaScript",ts:"TypeScript",typescript:"TypeScript",html:"HTML",css:"CSS",python:"Python",py:"Python",java:"Java",c:"C",cpp:"C++",csharp:"C#",go:"Go",rust:"Rust",php:"PHP",ruby:"Ruby",swift:"Swift",kotlin:"Kotlin",shell:"Shell",bash:"Bash",sql:"SQL",json:"JSON",xml:"XML",yaml:"YAML",markdown:"Markdown",md:"Markdown"}[t.language.toLowerCase()]||t.language))),d=()=>{navigator.clipboard.writeText(t.content).then((()=>{o.value=!0,setTimeout((()=>{o.value=!1}),2e3)})).catch((e=>{}))},c=()=>{s.value&&$.highlightElement(s.value)};return y((()=>{c()})),f((()=>t.content),(()=>{c()})),f((()=>t.language),(()=>{c()})),(a,l)=>(g(),b("div",q,[m("div",G,[m("div",N,C(i.value),1),m("div",W,[m("button",{class:"copy-button",onClick:d,title:n.value},[o.value?(g(),p(I(J),{key:1,width:"16",height:"16"})):(g(),p(I(R),{key:0,width:"16",height:"16"}))],8,X)])]),m("pre",Y,[m("code",{class:S(`language-${e.language}`),ref_key:"codeBlock",ref:s},C(e.content),3)])]))}}),[["__scopeId","data-v-17ba8f40"]]),Z={class:"loading-message"},ee={class:"loading-message__content"},ae={class:"loading-message__icon"},le=t(Object.assign({name:"LoadingMessage"},{__name:"LoadingMessage",props:{text:{type:String,default:"AI 正在思考中..."}},setup:e=>(e,a)=>(g(),b("div",Z,[m("div",ee,[m("div",ae,[B(I(V),{width:"24",height:"24"})])])]))}),[["__scopeId","data-v-970e1931"]]),te={key:0,class:"message-greeting"},se={key:0,class:"message-wrapper"},oe={class:"message-ask__content"},ne={key:0,class:"message-edit-container"},ie=["onKeydown"],de={class:"message-edit-actions"},ce=["onClick"],ue={key:1},re={key:2,class:"message-ask__btn"},pe=["onClick"],ge={key:1,class:"message-ai"},ve={class:"message-ai__content"},me={key:0,class:"message-ai__loading"},_e=["innerHTML"],he={class:"message-ai__btn"},ke=["onClick"],we=t(Object.assign({name:"顯示問與答"},{__name:"MessageRenderer",props:{isAiLoading:{type:Boolean,default:!1},loadingText:{type:String,default:"AI 正在思考中..."}},setup(a){const{t:l}=E(),t=e=>l(`main.${e}`),d=s(),c=e(),u=k(null),r=k(null),v=k(""),_=k(!1),h=k(!1),O=k(null),A=k("");k(0);const $=k(30);k(null);const V=a,R=w((()=>d.currentChatId?d.messages.filter((e=>{const a=e.session_id&&e.session_id===d.currentChatId,l=e.chat_id&&e.chat_id===d.currentChatId;let t=!1;if(!a&&!l){const a=d.chatHistory.find((e=>e.id===d.currentChatId));a&&a.messages&&(t=a.messages.some((a=>a.id===e.id)))}return a||l||t})).sort(((e,a)=>String(e.id).localeCompare(String(a.id)))):[])),J=e=>"user"===e.role,q=e=>"assistant"===e.role,G=e=>{if(!e)return[];const a=/```(\w*)\n([\s\S]*?)```/g,l=[];let t,s=0;for(;null!==(t=a.exec(e));){t.index>s&&l.push({type:"text",content:e.substring(s,t.index)});const a=t[1]||"plaintext";l.push({type:"code",language:a,content:t[2].trim()}),s=t.index+t[0].length}return s<e.length&&l.push({type:"text",content:e.substring(s)}),0===l.length&&l.push({type:"text",content:e}),l},N=()=>{var e;const a=null==(e=u.value)?void 0:e.closest(".chat");if(!a)return;const{scrollTop:l,scrollHeight:t,clientHeight:s}=a,o=t-l-s<200;h.value=!o},W=async(e=!0)=>{var a;const l=null==(a=u.value)?void 0:a.closest(".chat");l&&(l.scrollTo({top:l.scrollHeight,behavior:e?"smooth":"auto"}),setTimeout((()=>{N()}),300))};f((()=>R.value.length),((e,a)=>{if(e>a){const a=R.value[e-1];q(a)&&a.isTypingComplete}})),f((()=>c.params.id),(e=>{}));const X=e=>q(e)&&e.id===O.value&&!e.isTypingComplete?A.value:e.message,Y=()=>{W()};y((async()=>{var e;const a=localStorage.getItem("typingSpeed");a&&($.value=parseInt(a));const l=c.params.id;l&&(d.currentChatId=parseInt(l),await Z(l));const t=null==(e=u.value)?void 0:e.closest(".chat");t&&t.addEventListener("scroll",N)})),T((()=>{var e;const a=null==(e=u.value)?void 0:e.closest(".chat");a&&a.removeEventListener("scroll",N)}));const Z=async e=>{try{if("mock"===o())return;const a=localStorage.getItem("access_token"),l=localStorage.getItem("refresh_token"),t=localStorage.getItem("token_type");if(!a||!l||!t)return;const s=await n.getChatSessionsByID(e);if(!s)return;const c=await n.getMessagesBySessionID(e);if(c&&Array.isArray(c)){const a=c.map((a=>({...a,chat_id:e})));d.messages=[],a.forEach((e=>{d.addMessage(e)})),await x(),W(!1)}s.knowledge_base_id&&await i.getKnowledgeByID(s.knowledge_base_id)}catch(a){}},ee=e=>{navigator.clipboard.writeText(e).then((()=>{alert(t("copied"))})).catch((e=>{}))},ae=e=>{""!==v.value.trim()&&(d.updateMessage(e,{message:v.value,role:"user"}),r.value=null,v.value="")},we=()=>{r.value=null,v.value=""};return(e,a)=>(g(),b("div",{class:"message-container",ref_key:"messagesContainer",ref:u},[0===R.value.length?(g(),b("div",te,[a[1]||(a[1]=m("div",{class:"greeting-icon"},"👋",-1)),m("h2",null,C(t("greeting")),1),m("p",null,C(t("greetingSubtext")),1)])):(g(),b(M,{key:1},[(g(!0),b(M,null,j(R.value,((e,l)=>(g(),b(M,{key:e.id},[J(e)||q(e)&&""!==X(e)?(g(),b("div",se,[J(e)?(g(),b("article",{key:0,class:S(["message-ask",{editing:r.value===l}])},[m("div",oe,[r.value===l?(g(),b("div",ne,[F(m("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>v.value=e),class:"message-edit-textarea",rows:"3",onKeydown:[H(we,["esc"]),H(D((e=>ae(l)),["ctrl"]),["enter"])]},null,40,ie),[[K,v.value]]),m("div",de,[m("button",{class:"message-edit-cancel",onClick:we},C(t("cancel")),1),m("button",{class:"message-edit-save",onClick:e=>ae(l)},C(t("save")),9,ce)])])):(g(),b("p",ue,C(e.message),1)),r.value!==l?(g(),b("div",re,[m("button",{class:"message-action-btn",onClick:a=>ee(e.message),title:"複製"},[B(I(P),{width:"16",height:"16"})],8,pe),L("",!0)])):L("",!0)])],2)):L("",!0),q(e)?(g(),b("article",ge,[m("div",ve,[e.isLoading?(g(),b("div",me,a[2]||(a[2]=[m("div",{class:"loading-spinner"},null,-1)]))):L("",!0),(g(!0),b(M,null,j(G(X(e)),((e,a)=>{return g(),b(M,{key:a},["text"===e.type?(g(),b("div",{key:0,class:"message-ai__markdown",innerHTML:(l=e.content,z(l))},null,8,_e)):"code"===e.type?(g(),p(Q,{key:1,content:e.content,language:e.language},null,8,["content","language"])):L("",!0)],64);var l})),128))]),m("div",he,[m("button",{class:"message-action-btn",onClick:a=>ee(e.message),title:"複製"},[B(I(P),{width:"16",height:"16"})],8,ke)])])):L("",!0)])):L("",!0)],64)))),128)),V.isAiLoading?(g(),p(le,{key:0,text:V.loadingText,class:"message-wrapper"},null,8,["text"])):L("",!0)],64)),_.value?(g(),b("div",{key:2,class:"new-messages-alert",onClick:Y},[m("span",null,C(t("newMessages")),1)])):L("",!0),h.value?(g(),b("div",{key:3,class:"scroll-to-bottom",onClick:W},[B(I(U),{width:"24",height:"24"})])):L("",!0)],512))}}),[["__scopeId","data-v-e0b767ba"]]),ye=t(Object.assign({name:"對話視窗"},{__name:"Chat",props:{isAiLoading:{type:Boolean,default:!1}},setup(e,{expose:a}){const l=e,t=s(),o=w((()=>t.messages.length>0)),n=k(null),i=async(e=!0)=>{if(await x(),n.value){const a=n.value.scrollHeight;n.value.scrollTo({top:a,behavior:e?"smooth":"auto"}),setTimeout((()=>{if(n.value){const e=n.value.scrollTop,a=n.value.scrollHeight-n.value.clientHeight;e<a-10&&(n.value.scrollTop=a)}}),300)}};return y((()=>{setTimeout((()=>{i(!1)}),100)})),a({scrollToBottom:i}),(e,a)=>(g(),b("div",{class:S(["chat",[o.value?"flex-1":""]]),ref_key:"chatContainer",ref:n},[B(we,{class:"chat-messages","is-ai-loading":l.isAiLoading},null,8,["is-ai-loading"])],2))}}),[["__scopeId","data-v-f3f52250"]]),fe={class:"chat-top"},be={class:"chat-top__left"},Ce={class:"chat-top__title"},Ie={class:"chat-top__right"},Se={key:0,class:"knowledge-popup"},Be={class:"knowledge-popup__content"},Te={class:"knowledge-popup__header"},xe={class:"knowledge-popup__title"},Le=["disabled"],Me={key:0,class:"knowledge-popup__loading-overlay"},je={class:"knowledge-popup__loading-content"},Fe={class:"knowledge-popup__loading-status"},Ke={class:"knowledge-popup__body"},He={class:"knowledge-popup__form-group"},De={for:"knowledge-name"},Oe=["disabled"],Ae={class:"knowledge-popup__form-group"},$e={for:"knowledge-description"},Ee=["disabled"],ze={class:"knowledge-popup__form-group"},Pe={class:"knowledge-popup__file-upload"},Ve=["disabled"],Ue={class:"knowledge-popup__file-info"},Re={key:0,class:"knowledge-popup__form-group"},Je={class:"knowledge-popup__file-list"},qe={class:"knowledge-popup__file-name"},Ge=["onClick","disabled"],Ne={key:1,class:"knowledge-popup__form-group"},We={class:"knowledge-popup__file-list knowledge-popup__file-list--uploaded"},Xe={class:"knowledge-popup__file-name"},Ye={class:"knowledge-popup__file-badge"},Qe={class:"knowledge-popup__footer"},Ze=["disabled"],ea=["disabled"],aa={key:1,class:"model-popup"},la={class:"model-popup__content"},ta={class:"model-popup__header"},sa={class:"model-popup__title"},oa={class:"model-popup__body"},na={class:"model-popup__form-group"},ia=["value","selected"],da={key:0,class:"model-popup__description"},ca={key:1,class:"model-popup__current-model"},ua={class:"model-popup__current-model-label"},ra={class:"model-popup__current-model-name"},pa={class:"model-popup__footer"},ga=["disabled"],va=t(Object.assign({name:"對話頁面頂部"},{__name:"ChatTop",emits:["toggle-sidebar"],setup(l,{emit:t}){const{t:o}=E(),u=e=>o(`main.${e}`),r=e=>o(`auth.${e}`),p=a(),v=s(),_=e(),h=k(!1),x=t,H=()=>{h.value=window.innerWidth<768},D=()=>{x("toggle-sidebar")},A=k(!1),$=k(""),z=k(""),P=k([]),V=k(0),U=k([]),R=k(null),J=k(!1),q=k(!1),G=k(0),N=k(""),W=k(!1),X=k(null),Y=k([]),Q=`${u("knowledgeBaseName")}_${(new Date).toLocaleDateString("zh-TW").replace(/\//g,"")}`,Z=u("defaultDescription"),ee=w((()=>{const e=localStorage.getItem("access_token"),a=localStorage.getItem("refresh_token"),l=localStorage.getItem("token_type");return!!(e&&a&&l)})),ae=w((()=>{if(!v.currentChatId)return u("newChat");const e=v.chatHistory.find((e=>e.id===v.currentChatId));return e?e.title:u("newChat")})),le=()=>{p.push("/login")},te=()=>{p.push("/register")},se=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("token_type"),v.clearCurrentChat(),v.chatHistory=[],alert(r("logOutSuccess")),p.push("/"),setTimeout((()=>{window.location.reload()}),100)},oe=async()=>{try{const e=v.chatHistory.find((e=>e.id===v.currentChatId));if(e&&e.knowledge_base_id){const a=await i.getKnowledgeByID(e.knowledge_base_id);U.value=[a],R.value=a.id,await re(a.id)}}catch(e){}},ne=async()=>{if(!ee.value)return alert(r("notAuthenticated")),void le();A.value=!0,de(),await oe()},ie=()=>{q.value||(A.value=!1,de())},de=()=>{$.value="",z.value="",P.value=[],V.value=0,J.value=!1,q.value=!1,G.value=0,N.value=""},ce=e=>{const a=e.target.files;if(a.length>0)for(let l=0;l<a.length;l++)P.value.push({id:V.value++,name:a[l].name,size:a[l].size,file:a[l]})},ue=async()=>{if(!R.value)if(U.value.length>0)R.value=U.value[0].id;else try{const e=await i.postKnowledge({name:$.value||Q,description:z.value||Z});R.value=e.id}catch(e){return void alert(u("knowledgeBaseCreatedFailed")+e.message)}if(0!==P.value.filter((e=>!e.isFromKnowledgeBase)).length)try{q.value=!0,G.value=0,N.value=u("uploadingFiles");const l=P.value.filter((e=>!e.isFromKnowledgeBase)).map((e=>e.file)),t=(await i.getFileCompletionStream(R.value,l)).getReader(),s=new TextDecoder("utf-8");let o=!1;try{for(;!o;){const{value:e,done:l}=await t.read();if(o=l,e){const l=s.decode(e,{stream:!0}).split("\n").filter((e=>""!==e.trim()));for(const e of l)if(e.startsWith("data:")){const l=e.slice(5).trim();try{const e=JSON.parse(l);e.status&&(N.value=e.status),void 0!==e.progress&&(G.value=e.progress)}catch(a){}}}}}catch(e){throw new Error(u("uploadingFilesError"))}finally{try{N.value=u("uploadingFilesSuccess"),await t.cancel("流處理完成")}catch(a){}finally{t.releaseLock()}}N.value=u("gettingDocumentsList");const n=await i.getKnowledgeBasesDocs(R.value);n.length>0&&n.map((e=>({id:e.id,name:e.name}))),N.value=u("updatingKnowledgeBaseInfo");const d=await i.patchKnowledgeByID(R.value,{name:$.value||Q,description:z.value||Z});if(d&&d.source_documents){const e=P.value.map((e=>e.id)),a=d.source_documents.map(((a,l)=>({id:a.id||Math.max(...e,0)+l+1,name:a.name,size:a.size||0,isFromKnowledgeBase:!0})));P.value=a}N.value=u("knowledgeBaseUpdatedSuccess"),alert(u("knowledgeBaseUpdatedSuccess")),q.value=!1,ie()}catch(e){alert(u("operationFailed")+(e instanceof Error?e.message:u("unknownError"))),q.value=!1}else alert(u("pleaseSelectAtLeastOneFile"))},re=async e=>{try{N.value=u("gettingKnowledgeBaseDetails");const a=await i.getKnowledgeByID(e);if(a&&a.source_documents&&a.source_documents.length>0){const e=a.source_documents.map(((e,a)=>({id:e.id||`kb-${a}`,name:e.name||e.filename||`文件 ${a+1}`,size:e.size||0,isFromKnowledgeBase:!0}))),l=P.value.map((e=>e.id));P.value=[...P.value.filter((e=>!e.isFromKnowledgeBase)),...e.filter((e=>!l.includes(e.id)))],a.name&&($.value=a.name),a.description&&(z.value=a.description)}N.value=""}catch(a){N.value=""}},pe=async()=>{try{const e=await c.getAvailableModels();if(Array.isArray(e)){if(Y.value=e,v.currentChatId){const e=v.chatHistory.find((e=>e.id===v.currentChatId));if(null==e?void 0:e.llm_id)return void(X.value=e.llm_id)}const a=localStorage.getItem("llm_id");a&&Y.value.some((e=>e.id===parseInt(a)))?X.value=parseInt(a):Y.value.length>0&&(X.value=Y.value[0].id)}else Y.value=[]}catch(e){if(Y.value=[{id:1,model:"gpt-3.5-turbo",display_name:"GPT-3.5 Turbo"},{id:2,model:"gpt-4",display_name:"GPT-4"},{id:3,model:"llama3.1:8b-instruct-q8_0",display_name:"Llama 3.1 (8B)"}],v.currentChatId){const e=v.chatHistory.find((e=>e.id===v.currentChatId));if((null==e?void 0:e.llm_id)&&Y.value.some((a=>a.id===e.llm_id)))return void(X.value=e.llm_id)}X.value=3}},ge=async()=>{if(!ee.value)return alert(r("notAuthenticated")),void le();X.value=null,await pe(),W.value=!0},ve=async()=>{if(X.value)try{if(localStorage.setItem("llm_id",X.value.toString()),v.currentLLMId=X.value,v.currentChatId){await n.patchChatSessionsByID(v.currentChatId,{llm_id:X.value}),await n.getMessagesBySessionID(v.currentChatId);const e=v.chatHistory.find((e=>e.id===v.currentChatId));(null==e?void 0:e.knowledge_base_id)&&await i.getKnowledgeByID(e.knowledge_base_id)}alert(u("modelUpdatedSuccess")),ke()}catch(e){alert(u("updateModelFailed")+(e instanceof Error?e.message:u("unknownError")))}},me=w((()=>X.value?Y.value.find((e=>e.id===X.value)):null)),_e=w((()=>{const e=me.value;return e?e.description||u("noDescription"):""})),he=w((()=>{var e;return null==(e=v.chatHistory.find((e=>e.id===v.currentChatId)))?void 0:e.model}));y((async()=>{H(),window.addEventListener("resize",H),ee.value&&(await oe(),await pe())})),T((()=>{window.removeEventListener("resize",H)})),f((()=>_.path),(()=>{(async()=>{ee.value&&_.path.includes("/chat")&&await oe()})()}));const ke=()=>{W.value=!1};return(e,a)=>(g(),b(M,null,[m("div",fe,[m("div",be,[h.value?(g(),b("button",{key:0,class:"chat-top__sidebar-toggle",onClick:D,title:"展開側邊欄"},[B(I(d),{direction:"right"})])):L("",!0),m("h2",Ce,C(ae.value),1)]),m("div",Ie,[m("button",{class:"chat-top__btn chat-top__btn--knowledge",onClick:ne},C(u("knowledgeBaseSetting")),1),m("button",{class:"chat-top__btn chat-top__btn--model",onClick:ge},C(u("modelSetting")),1),ee.value?(g(),b("button",{key:1,class:"chat-top__btn chat-top__btn--logout",onClick:se},C(r("logOut")),1)):(g(),b(M,{key:0},[m("button",{class:"chat-top__btn chat-top__btn--login",onClick:le},C(r("logIn")),1),m("button",{class:"chat-top__btn chat-top__btn--register",onClick:te},C(r("register")),1)],64))])]),A.value?(g(),b("div",Se,[m("div",{class:S(["knowledge-popup__overlay",{"knowledge-popup__overlay--uploading":q.value}]),onClick:ie},null,2),m("div",Be,[m("div",Te,[m("h3",xe,C(u("knowledgeBaseSetting")),1),m("button",{class:"knowledge-popup__close",onClick:ie,disabled:q.value},"×",8,Le)]),q.value?(g(),b("div",Me,[m("div",je,[a[3]||(a[3]=m("div",{class:"knowledge-popup__spinner"},null,-1)),m("div",Fe,[m("h4",null,C(N.value),1)])])])):L("",!0),m("div",Ke,[m("div",He,[m("label",De,C(u("knowledgeBaseName")),1),F(m("input",{type:"text",id:"knowledge-name","onUpdate:modelValue":a[0]||(a[0]=e=>$.value=e),class:"knowledge-popup__input",placeholder:"請輸入知識庫名稱",disabled:q.value},null,8,Oe),[[K,$.value]])]),m("div",Ae,[m("label",$e,C(u("knowledgeBaseDescription")),1),F(m("textarea",{id:"knowledge-description","onUpdate:modelValue":a[1]||(a[1]=e=>z.value=e),class:"knowledge-popup__textarea",placeholder:"請輸入知識庫描述",rows:"3",disabled:q.value},null,8,Ee),[[K,z.value]])]),m("div",ze,[m("label",null,C(u("knowledgeBaseFile")),1),m("div",Pe,[m("input",{type:"file",id:"knowledge-file",onChange:ce,class:"knowledge-popup__file-input",multiple:"",disabled:q.value},null,40,Ve),m("label",{for:"knowledge-file",class:S(["knowledge-popup__file-label",{disabled:q.value}])},C(u("chooseFile")),3),m("span",Ue,C(u("supportFileFormat")),1)])]),P.value.some((e=>!e.isFromKnowledgeBase))?(g(),b("div",Re,[m("label",null,C(u("uploadFileSequence"))+": "+C(P.value.filter((e=>!e.isFromKnowledgeBase)).length),1),m("ul",Je,[(g(!0),b(M,null,j(P.value.filter((e=>!e.isFromKnowledgeBase)),(e=>(g(),b("li",{key:e.id,class:"knowledge-popup__file-item"},[m("span",qe,C(e.name),1),m("button",{class:"knowledge-popup__file-remove",onClick:a=>{return l=e.id,void(P.value=P.value.filter((e=>e.id!==l)));var l},disabled:q.value}," × ",8,Ge)])))),128))])])):L("",!0),P.value.some((e=>e.isFromKnowledgeBase))?(g(),b("div",Ne,[m("label",null,C(u("uploadedKnowledgeBaseFile"))+": "+C(P.value.filter((e=>e.isFromKnowledgeBase)).length),1),m("ul",We,[(g(!0),b(M,null,j(P.value.filter((e=>e.isFromKnowledgeBase)),(e=>(g(),b("li",{key:e.id,class:"knowledge-popup__file-item knowledge-popup__file-item--uploaded"},[m("span",Xe,C(e.name),1),m("span",Ye,C(u("uploaded")),1)])))),128))])])):L("",!0)]),m("div",Qe,[m("button",{class:"knowledge-popup__btn knowledge-popup__btn--cancel",onClick:ie,disabled:q.value},C(q.value?u("canceling"):u("cancel")),9,Ze),m("button",{class:"knowledge-popup__btn knowledge-popup__btn--confirm",onClick:ue,disabled:q.value},C(q.value?u("uploading"):u("confirm")),9,ea)])])])):L("",!0),W.value?(g(),b("div",aa,[m("div",{class:"model-popup__overlay",onClick:ke}),m("div",la,[m("div",ta,[m("h3",sa,C(u("modelSetting")),1),m("button",{class:"model-popup__close",onClick:ke},"×")]),m("div",oa,[m("div",na,[m("label",null,C(u("chooseModel")),1),F(m("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>X.value=e),class:"model-popup__select"},[(g(!0),b(M,null,j(Y.value,(e=>(g(),b("option",{key:e.id,value:e.id,selected:e.id===X.value},C(e.display_name||e.model),9,ia)))),128))],512),[[O,X.value]]),_e.value?(g(),b("div",da,C(_e.value),1)):L("",!0),me.value?(g(),b("div",ca,[m("div",ua,C(u("currentModel"))+":",1),m("div",ra,C(he.value),1)])):L("",!0)])]),m("div",pa,[m("button",{class:"model-popup__btn model-popup__btn--cancel",onClick:ke},C(u("cancel")),1),m("button",{class:"model-popup__btn model-popup__btn--confirm",onClick:ve,disabled:!X.value},C(u("confirm")),9,ga)])])])):L("",!0)],64))}}),[["__scopeId","data-v-e45a0c47"]]),ma={class:"wrap"},_a={key:0,class:"loading-container"},ha={key:1,class:"error-container"},ka={key:2,class:"chat-container"},wa={class:"chat-input-container"},ya=t(Object.assign({name:"對話頁面"},{__name:"ChatView",setup(l){const{t:t}=E(),o=e=>t(`main.${e}`),n=e(),i=a(),d=s(),c=k(!0),p=k(!1),v=k(!1),_=k(!1),h=k(null),w=k(null),S=()=>{h.value&&h.value.toggleSider()},T=(e=!0)=>{w.value&&w.value.scrollToBottom(e)},L=async e=>{try{d.chatHistory.some((a=>a.id==e))?(d.loadChat(parseInt(e)),c.value=!1,await x(),setTimeout((()=>{T(!1)}),300)):i.push("/")}catch(a){p.value=!0,c.value=!1}},M=async e=>{v.value=!0,setTimeout((()=>{T()}),100)},j=e=>{v.value=e,_.value=e,e||setTimeout((()=>{T()}),300)};return f((()=>n.params.id),(e=>{var a;e&&e!==(null==(a=d.currentChatId)?void 0:a.toString())&&(c.value=!0,L(e))})),f((()=>d.messages.length),((e,a)=>{e>a&&setTimeout((()=>{T()}),100)})),A((()=>{const e=n.params.id;L(e)})),y((()=>{setTimeout((()=>{T(!1)}),500)})),(e,a)=>(g(),b("div",ma,[B(u,{ref_key:"sidebarRef",ref:h},null,512),c.value?(g(),b("div",_a,[a[1]||(a[1]=m("div",{class:"loading-spinner"},null,-1)),m("p",null,C(o("loading")),1)])):p.value?(g(),b("div",ha,[a[2]||(a[2]=m("div",{class:"error-icon"},"⚠️",-1)),m("h3",null,C(o("error")),1),m("p",null,C(o("error_message")),1),m("button",{onClick:a[0]||(a[0]=e=>I(i).push("/")),class:"error-button"},C(o("back_to_home")),1)])):(g(),b("div",ka,[B(va,{onToggleSidebar:S}),B(ye,{ref_key:"chatComponent",ref:w,"is-ai-loading":_.value},null,8,["is-ai-loading"]),m("div",wa,[B(r,{onProcessingStateChange:j,onMessageSubmit:M,"is-loading":v.value},null,8,["is-loading"])])]))]))}}),[["__scopeId","data-v-ed38d796"]]);export{ya as default};
