import{a as e,u as a}from"./router-BfBgOAHe.js";import{I as l,_ as t,u as s,a as o,g as n,c as i,k as c,C as d,s as u,S as r,M as p}from"./index-B31Lcd9_.js";import{G as g,D as v,C as m,A as _,L as h,M as w,r as k,c as y,o as f,w as b,z as C,B as I,u as S,P as B,f as T,b as x,n as L,I as M,F as j,O as F,Q as K,R as H,V as D,W as O,X as A,Y as $}from"./vue-core-BoiL1HRa.js";import{H as E}from"./highlight-BSaeFFC4.js";import{u as z}from"./i18n-CeE1QK4V.js";import{m as P}from"./marked-txETn4SA.js";import"./state-BPcB45lV.js";import"./vendor-CJNHjaSW.js";import"./mock-C46Gfhfc.js";const V=Object.assign({name:"CopyIcon"},{__name:"CopyIcon",setup:e=>(e,a)=>(v(),g(l,h(w(e.$attrs)),{default:m((()=>a[0]||(a[0]=[_("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"},null,-1),_("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"},null,-1)]))),_:1},16))}),U=t(Object.assign({name:"LoadingIcon"},{__name:"LoadingIcon",setup:e=>(e,a)=>(v(),g(l,h(w(e.$attrs)),{default:m((()=>a[0]||(a[0]=[_("circle",{cx:"12",cy:"12",r:"10",class:"loading-circle"},null,-1),_("path",{class:"loading-path",d:"M12 2a10 10 0 0 1 10 10"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-91a0c3ed"]]),R=t(Object.assign({name:"ScrollToBottomIcon"},{__name:"ScrollToBottomIcon",setup:e=>(e,a)=>(v(),g(l,h(w(e.$attrs)),{default:m((()=>a[0]||(a[0]=[_("polyline",{points:"6 9 12 15 18 9","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-58f52f69"]]),J=t(Object.assign({name:"CopyCodeIcon"},{__name:"CopyCodeIcon",setup:e=>(e,a)=>(v(),g(l,h(w(e.$attrs)),{default:m((()=>a[0]||(a[0]=[_("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"},null,-1),_("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-e90347b2"]]),q=t(Object.assign({name:"CheckIcon"},{__name:"CheckIcon",setup:e=>(e,a)=>(v(),g(l,h(w(e.$attrs)),{default:m((()=>a[0]||(a[0]=[_("polyline",{points:"20 6 9 17 4 12"},null,-1)]))),_:1},16))}),[["__scopeId","data-v-75117b05"]]),G={class:"code-block"},N={class:"code-header"},W={class:"code-language"},Q={class:"code-actions"},X=["title"],Y={class:"code-content"},Z=t(Object.assign({name:"程式碼區塊"},{__name:"CodeBlock",props:{content:{type:String,required:!0,default:""},language:{type:String,default:"javascript"}},setup(e){const{t:a}=z(),l=e=>a(`main.${e}`),t=e,s=k(null),o=k(!1),n=y((()=>o.value?l("copied"):l("copyCode"))),i=y((()=>({js:"JavaScript",javascript:"JavaScript",ts:"TypeScript",typescript:"TypeScript",html:"HTML",css:"CSS",python:"Python",py:"Python",java:"Java",c:"C",cpp:"C++",csharp:"C#",go:"Go",rust:"Rust",php:"PHP",ruby:"Ruby",swift:"Swift",kotlin:"Kotlin",shell:"Shell",bash:"Bash",sql:"SQL",json:"JSON",xml:"XML",yaml:"YAML",markdown:"Markdown",md:"Markdown"}[t.language.toLowerCase()]||t.language))),c=()=>{navigator.clipboard.writeText(t.content).then((()=>{o.value=!0,setTimeout((()=>{o.value=!1}),2e3)})).catch((e=>{}))},d=()=>{s.value&&E.highlightElement(s.value)};return f((()=>{d()})),b((()=>t.content),(()=>{d()})),b((()=>t.language),(()=>{d()})),(a,l)=>(v(),C("div",G,[_("div",N,[_("div",W,I(i.value),1),_("div",Q,[_("button",{class:"copy-button",onClick:c,title:n.value},[o.value?(v(),g(S(q),{key:1,width:"16",height:"16"})):(v(),g(S(J),{key:0,width:"16",height:"16"}))],8,X)])]),_("pre",Y,[_("code",{class:B(`language-${e.language}`),ref_key:"codeBlock",ref:s},I(e.content),3)])]))}}),[["__scopeId","data-v-17ba8f40"]]),ee={class:"loading-message"},ae={class:"loading-message__content"},le={class:"loading-message__icon"},te=t(Object.assign({name:"LoadingMessage"},{__name:"LoadingMessage",props:{text:{type:String,default:"AI 正在思考中..."}},setup:e=>(e,a)=>(v(),C("div",ee,[_("div",ae,[_("div",le,[T(S(U),{width:"24",height:"24"})])])]))}),[["__scopeId","data-v-970e1931"]]),se={key:0,class:"message-greeting"},oe={key:0,class:"message-wrapper"},ne={class:"message-ask__content"},ie={key:0,class:"message-edit-container"},ce=["onKeydown"],de={class:"message-edit-actions"},ue=["onClick"],re={key:1},pe={key:2,class:"message-ask__btn"},ge=["onClick"],ve={key:1,class:"message-ai"},me={class:"message-ai__content"},_e={key:0,class:"message-ai__loading"},he=["innerHTML"],we={class:"message-ai__btn"},ke=["onClick"],ye=t(Object.assign({name:"顯示問與答"},{__name:"MessageRenderer",props:{isAiLoading:{type:Boolean,default:!1},loadingText:{type:String,default:"AI 正在思考中..."}},setup(a){const l=s(),{t:t}=z(),d=e=>t(`main.${e}`),u=o(),r=e(),p=k(null),m=k(null),h=k(""),w=k(!1),A=k(!1),$=k(null),E=k("");k(0);const U=k(30);k(null);const J=a,q=y((()=>u.currentChatId?u.messages.filter((e=>{const a=e.session_id&&e.session_id===u.currentChatId,l=e.chat_id&&e.chat_id===u.currentChatId;let t=!1;if(!a&&!l){const a=u.chatHistory.find((e=>e.id===u.currentChatId));a&&a.messages&&(t=a.messages.some((a=>a.id===e.id)))}return a||l||t})).sort(((e,a)=>String(e.id).localeCompare(String(a.id)))):[])),G=e=>"user"===e.role,N=e=>"assistant"===e.role,W=e=>{if(!e)return[];const a=/```(\w*)\n([\s\S]*?)```/g,l=[];let t,s=0;for(;null!==(t=a.exec(e));){t.index>s&&l.push({type:"text",content:e.substring(s,t.index)});const a=t[1]||"plaintext";l.push({type:"code",language:a,content:t[2].trim()}),s=t.index+t[0].length}return s<e.length&&l.push({type:"text",content:e.substring(s)}),0===l.length&&l.push({type:"text",content:e}),l},Q=()=>{var e;const a=null==(e=p.value)?void 0:e.closest(".chat");if(!a)return;const{scrollTop:l,scrollHeight:t,clientHeight:s}=a,o=t-l-s<200;A.value=!o},X=async(e=!0)=>{var a;const l=null==(a=p.value)?void 0:a.closest(".chat");l&&(l.scrollTo({top:l.scrollHeight,behavior:e?"smooth":"auto"}),setTimeout((()=>{Q()}),300))};b((()=>q.value.length),((e,a)=>{if(e>a){const a=q.value[e-1];N(a)&&a.isTypingComplete}})),b((()=>r.params.id),(e=>{}));const Y=e=>N(e)&&e.id===$.value&&!e.isTypingComplete?E.value:e.message,ee=()=>{X()};f((async()=>{var e;const a=localStorage.getItem("typingSpeed");a&&(U.value=parseInt(a));const l=r.params.id;l&&(u.currentChatId=parseInt(l),await ae(l));const t=null==(e=p.value)?void 0:e.closest(".chat");t&&t.addEventListener("scroll",Q)})),x((()=>{var e;const a=null==(e=p.value)?void 0:e.closest(".chat");a&&a.removeEventListener("scroll",Q)}));const ae=async e=>{try{if("mock"===n())return;const a=localStorage.getItem("access_token"),l=localStorage.getItem("refresh_token"),t=localStorage.getItem("token_type");if(!a||!l||!t)return;const s=await i.getChatSessionsByID(e);if(!s)return;const o=await i.getMessagesBySessionID(e);if(o&&Array.isArray(o)){const a=o.map((a=>({...a,chat_id:e})));u.messages=[],a.forEach((e=>{u.addMessage(e)})),await L(),X(!1)}s.knowledge_base_id&&await c.getKnowledgeByID(s.knowledge_base_id)}catch(a){}},le=e=>{navigator.clipboard.writeText(e).then((()=>{l.show(d("copied"),"success",1500)})).catch((e=>{}))},ye=e=>{""!==h.value.trim()&&(u.updateMessage(e,{message:h.value,role:"user"}),m.value=null,h.value="")},fe=()=>{m.value=null,h.value=""};return(e,a)=>(v(),C("div",{class:"message-container",ref_key:"messagesContainer",ref:p},[0===q.value.length?(v(),C("div",se,[a[1]||(a[1]=_("div",{class:"greeting-icon"},"👋",-1)),_("h2",null,I(d("greeting")),1),_("p",null,I(d("greetingSubtext")),1)])):(v(),C(j,{key:1},[(v(!0),C(j,null,F(q.value,((e,l)=>(v(),C(j,{key:e.id},[G(e)||N(e)&&""!==Y(e)?(v(),C("div",oe,[G(e)?(v(),C("article",{key:0,class:B(["message-ask",{editing:m.value===l}])},[_("div",ne,[m.value===l?(v(),C("div",ie,[K(_("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>h.value=e),class:"message-edit-textarea",rows:"3",onKeydown:[D(fe,["esc"]),D(O((e=>ye(l)),["ctrl"]),["enter"])]},null,40,ce),[[H,h.value]]),_("div",de,[_("button",{class:"message-edit-cancel",onClick:fe},I(d("cancel")),1),_("button",{class:"message-edit-save",onClick:e=>ye(l)},I(d("save")),9,ue)])])):(v(),C("p",re,I(e.message),1)),m.value!==l?(v(),C("div",pe,[_("button",{class:"message-action-btn",onClick:a=>le(e.message),title:"複製"},[T(S(V),{width:"16",height:"16"})],8,ge),M("",!0)])):M("",!0)])],2)):M("",!0),N(e)?(v(),C("article",ve,[_("div",me,[e.isLoading?(v(),C("div",_e,a[2]||(a[2]=[_("div",{class:"loading-spinner"},null,-1)]))):M("",!0),(v(!0),C(j,null,F(W(Y(e)),((e,a)=>{return v(),C(j,{key:a},["text"===e.type?(v(),C("div",{key:0,class:"message-ai__markdown",innerHTML:(l=e.content,P(l))},null,8,he)):"code"===e.type?(v(),g(Z,{key:1,content:e.content,language:e.language},null,8,["content","language"])):M("",!0)],64);var l})),128))]),_("div",we,[_("button",{class:"message-action-btn",onClick:a=>le(e.message),title:"複製"},[T(S(V),{width:"16",height:"16"})],8,ke)])])):M("",!0)])):M("",!0)],64)))),128)),J.isAiLoading?(v(),g(te,{key:0,text:J.loadingText,class:"message-wrapper"},null,8,["text"])):M("",!0)],64)),w.value?(v(),C("div",{key:2,class:"new-messages-alert",onClick:ee},[_("span",null,I(d("newMessages")),1)])):M("",!0),A.value?(v(),C("div",{key:3,class:"scroll-to-bottom",onClick:X},[T(S(R),{width:"24",height:"24"})])):M("",!0)],512))}}),[["__scopeId","data-v-e7fdf364"]]),fe=t(Object.assign({name:"對話視窗"},{__name:"Chat",props:{isAiLoading:{type:Boolean,default:!1}},setup(e,{expose:a}){const l=e,t=o(),s=y((()=>t.messages.length>0)),n=k(null),i=async(e=!0)=>{if(await L(),n.value){const a=n.value.scrollHeight;n.value.scrollTo({top:a,behavior:e?"smooth":"auto"}),setTimeout((()=>{if(n.value){const e=n.value.scrollTop,a=n.value.scrollHeight-n.value.clientHeight;e<a-10&&(n.value.scrollTop=a)}}),300)}};return f((()=>{setTimeout((()=>{i(!1)}),100)})),a({scrollToBottom:i}),(e,a)=>(v(),C("div",{class:B(["chat",[s.value?"flex-1":""]]),ref_key:"chatContainer",ref:n},[T(ye,{class:"chat-messages","is-ai-loading":l.isAiLoading},null,8,["is-ai-loading"])],2))}}),[["__scopeId","data-v-f3f52250"]]),be={class:"chat-top"},Ce={class:"chat-top__left"},Ie={class:"chat-top__title"},Se={class:"chat-top__right"},Be={key:0,class:"knowledge-popup"},Te={class:"knowledge-popup__content"},xe={class:"knowledge-popup__header"},Le={class:"knowledge-popup__title"},Me=["disabled"],je={key:0,class:"knowledge-popup__loading-overlay"},Fe={class:"knowledge-popup__loading-content"},Ke={class:"knowledge-popup__loading-status"},He={class:"knowledge-popup__body"},De={class:"knowledge-popup__form-group"},Oe={for:"knowledge-name"},Ae=["disabled"],$e={class:"knowledge-popup__form-group"},Ee={for:"knowledge-description"},ze=["disabled"],Pe={class:"knowledge-popup__form-group"},Ve={class:"knowledge-popup__file-upload"},Ue=["disabled"],Re={class:"knowledge-popup__file-info"},Je={key:0,class:"knowledge-popup__form-group"},qe={class:"knowledge-popup__file-list"},Ge={class:"knowledge-popup__file-name"},Ne=["onClick","disabled"],We={key:1,class:"knowledge-popup__form-group"},Qe={class:"knowledge-popup__file-list knowledge-popup__file-list--uploaded"},Xe={class:"knowledge-popup__file-name"},Ye={class:"knowledge-popup__file-badge"},Ze={class:"knowledge-popup__footer"},ea=["disabled"],aa=["disabled"],la={key:1,class:"model-popup"},ta={class:"model-popup__content"},sa={class:"model-popup__header"},oa={class:"model-popup__title"},na={class:"model-popup__body"},ia={class:"model-popup__form-group"},ca=["value","selected"],da={key:0,class:"model-popup__description"},ua={key:1,class:"model-popup__current-model"},ra={class:"model-popup__current-model-label"},pa={class:"model-popup__current-model-name"},ga={class:"model-popup__footer"},va=["disabled"],ma=t(Object.assign({name:"對話頁面頂部"},{__name:"ChatTop",emits:["toggle-sidebar"],setup(l,{emit:t}){const n=s(),{t:r}=z(),p=e=>r(`main.${e}`),g=e=>r(`auth.${e}`),m=a(),h=o(),w=e(),L=k(!1),D=t,O=()=>{L.value=window.innerWidth<768},$=()=>{D("toggle-sidebar")},E=k(!1),P=k(""),V=k(""),U=k([]),R=k(0),J=k([]),q=k(null),G=k(!1),N=k(!1),W=k(0),Q=k(""),X=k(!1),Y=k(null),Z=k([]),ee=`${p("knowledgeBaseName")}_${(new Date).toLocaleDateString("zh-TW").replace(/\//g,"")}`,ae=p("defaultDescription"),le=y((()=>{const e=localStorage.getItem("access_token"),a=localStorage.getItem("refresh_token"),l=localStorage.getItem("token_type");return!!(e&&a&&l)})),te=y((()=>{if(!h.currentChatId)return p("newChat");const e=h.chatHistory.find((e=>e.id===h.currentChatId));return e?e.title:p("newChat")})),se=()=>{m.push("/login")},oe=()=>{m.push("/register")},ne=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("token_type"),h.clearCurrentChat(),h.chatHistory=[],n.show(g("logOutSuccess"),"success",1500),m.push("/"),setTimeout((()=>{window.location.reload()}),100)},ie=async()=>{try{const e=h.chatHistory.find((e=>e.id===h.currentChatId));if(e&&e.knowledge_base_id){const a=await c.getKnowledgeByID(e.knowledge_base_id);J.value=[a],q.value=a.id,await ge(a.id)}}catch(e){}},ce=async()=>{if(!le.value)return n.show(g("notAuthenticated"),"warning",1500),void se();E.value=!0,ue(),await ie()},de=()=>{N.value||(E.value=!1,ue())},ue=()=>{P.value="",V.value="",U.value=[],R.value=0,G.value=!1,N.value=!1,W.value=0,Q.value=""},re=e=>{const a=e.target.files;if(a.length>0)for(let l=0;l<a.length;l++)U.value.push({id:R.value++,name:a[l].name,size:a[l].size,file:a[l]})},pe=async()=>{if(!q.value)if(J.value.length>0)q.value=J.value[0].id;else try{const e=await c.postKnowledge({name:P.value||ee,description:V.value||ae});q.value=e.id}catch(e){return void n.show(p("knowledgeBaseCreatedFailed")+e.message,"error",1500)}if(0!==U.value.filter((e=>!e.isFromKnowledgeBase)).length)try{N.value=!0,W.value=0,Q.value=p("uploadingFiles");const l=U.value.filter((e=>!e.isFromKnowledgeBase)).map((e=>e.file)),t=(await c.getFileCompletionStream(q.value,l)).getReader(),s=new TextDecoder("utf-8");let o=!1;try{for(;!o;){const{value:e,done:l}=await t.read();if(o=l,e){const l=s.decode(e,{stream:!0}).split("\n").filter((e=>""!==e.trim()));for(const e of l)if(e.startsWith("data:")){const l=e.slice(5).trim();try{const e=JSON.parse(l);e.status&&(Q.value=e.status),void 0!==e.progress&&(W.value=e.progress)}catch(a){}}}}}catch(e){throw new Error(p("uploadingFilesError"))}finally{try{Q.value=p("uploadingFilesSuccess"),await t.cancel("流處理完成")}catch(a){}finally{t.releaseLock()}}Q.value=p("gettingDocumentsList");const i=await c.getKnowledgeBasesDocs(q.value);i.length>0&&i.map((e=>({id:e.id,name:e.name}))),Q.value=p("updatingKnowledgeBaseInfo");const d=await c.patchKnowledgeByID(q.value,{name:P.value||ee,description:V.value||ae});if(d&&d.source_documents){const e=U.value.map((e=>e.id)),a=d.source_documents.map(((a,l)=>({id:a.id||Math.max(...e,0)+l+1,name:a.name,size:a.size||0,isFromKnowledgeBase:!0})));U.value=a}Q.value=p("knowledgeBaseUpdatedSuccess"),n.show(p("knowledgeBaseUpdatedSuccess"),"success",1500),N.value=!1,de()}catch(e){n.show(p("operationFailed")+(e instanceof Error?e.message:p("unknownError")),"error",1500),N.value=!1}else n.show(p("pleaseSelectAtLeastOneFile"),"warning",1500)},ge=async e=>{try{Q.value=p("gettingKnowledgeBaseDetails");const a=await c.getKnowledgeByID(e);if(a&&a.source_documents&&a.source_documents.length>0){const e=a.source_documents.map(((e,a)=>({id:e.id||`kb-${a}`,name:e.name||e.filename||`文件 ${a+1}`,size:e.size||0,isFromKnowledgeBase:!0}))),l=U.value.map((e=>e.id));U.value=[...U.value.filter((e=>!e.isFromKnowledgeBase)),...e.filter((e=>!l.includes(e.id)))],a.name&&(P.value=a.name),a.description&&(V.value=a.description)}Q.value=""}catch(a){Q.value=""}},ve=async()=>{try{const e=await u.getAvailableModels();if(Array.isArray(e)){if(Z.value=e,h.currentChatId){const e=h.chatHistory.find((e=>e.id===h.currentChatId));if(null==e?void 0:e.llm_id)return void(Y.value=e.llm_id)}const a=localStorage.getItem("llm_id");a&&Z.value.some((e=>e.id===parseInt(a)))?Y.value=parseInt(a):Z.value.length>0&&(Y.value=Z.value[0].id)}else Z.value=[]}catch(e){if(Z.value=[{id:1,model:"gpt-3.5-turbo",display_name:"GPT-3.5 Turbo"},{id:2,model:"gpt-4",display_name:"GPT-4"},{id:3,model:"llama3.1:8b-instruct-q8_0",display_name:"Llama 3.1 (8B)"}],h.currentChatId){const e=h.chatHistory.find((e=>e.id===h.currentChatId));if((null==e?void 0:e.llm_id)&&Z.value.some((a=>a.id===e.llm_id)))return void(Y.value=e.llm_id)}Y.value=3}},me=async()=>{if(!le.value)return n.show(g("notAuthenticated"),"warning",1500),void se();Y.value=null,await ve(),X.value=!0},_e=async()=>{if(Y.value)try{if(localStorage.setItem("llm_id",Y.value.toString()),h.currentLLMId=Y.value,h.currentChatId){await i.patchChatSessionsByID(h.currentChatId,{llm_id:Y.value}),await i.getMessagesBySessionID(h.currentChatId);const e=h.chatHistory.find((e=>e.id===h.currentChatId));(null==e?void 0:e.knowledge_base_id)&&await c.getKnowledgeByID(e.knowledge_base_id)}n.show(p("modelUpdatedSuccess"),"success",1500),ye()}catch(e){n.show(p("updateModelFailed")+(e instanceof Error?e.message:p("unknownError")),"error",1500)}},he=y((()=>Y.value?Z.value.find((e=>e.id===Y.value)):null)),we=y((()=>{const e=he.value;return e?e.description||p("noDescription"):""})),ke=y((()=>{var e;return null==(e=h.chatHistory.find((e=>e.id===h.currentChatId)))?void 0:e.model}));f((async()=>{O(),window.addEventListener("resize",O),le.value&&(await ie(),await ve())})),x((()=>{window.removeEventListener("resize",O)})),b((()=>w.path),(()=>{(async()=>{le.value&&w.path.includes("/chat")&&await ie()})()}));const ye=()=>{X.value=!1};return(e,a)=>(v(),C(j,null,[_("div",be,[_("div",Ce,[L.value?(v(),C("button",{key:0,class:"chat-top__sidebar-toggle",onClick:$,title:"展開側邊欄"},[T(S(d),{direction:"right"})])):M("",!0),_("h2",Ie,I(te.value),1)]),_("div",Se,[_("button",{class:"chat-top__btn chat-top__btn--knowledge",onClick:ce},I(p("knowledgeBaseSetting")),1),_("button",{class:"chat-top__btn chat-top__btn--model",onClick:me},I(p("modelSetting")),1),le.value?(v(),C("button",{key:1,class:"chat-top__btn chat-top__btn--logout",onClick:ne},I(g("logOut")),1)):(v(),C(j,{key:0},[_("button",{class:"chat-top__btn chat-top__btn--login",onClick:se},I(g("logIn")),1),_("button",{class:"chat-top__btn chat-top__btn--register",onClick:oe},I(g("register")),1)],64))])]),E.value?(v(),C("div",Be,[_("div",{class:B(["knowledge-popup__overlay",{"knowledge-popup__overlay--uploading":N.value}]),onClick:de},null,2),_("div",Te,[_("div",xe,[_("h3",Le,I(p("knowledgeBaseSetting")),1),_("button",{class:"knowledge-popup__close",onClick:de,disabled:N.value},"×",8,Me)]),N.value?(v(),C("div",je,[_("div",Fe,[a[3]||(a[3]=_("div",{class:"knowledge-popup__spinner"},null,-1)),_("div",Ke,[_("h4",null,I(Q.value),1)])])])):M("",!0),_("div",He,[_("div",De,[_("label",Oe,I(p("knowledgeBaseName")),1),K(_("input",{type:"text",id:"knowledge-name","onUpdate:modelValue":a[0]||(a[0]=e=>P.value=e),class:"knowledge-popup__input",placeholder:"請輸入知識庫名稱",disabled:N.value},null,8,Ae),[[H,P.value]])]),_("div",$e,[_("label",Ee,I(p("knowledgeBaseDescription")),1),K(_("textarea",{id:"knowledge-description","onUpdate:modelValue":a[1]||(a[1]=e=>V.value=e),class:"knowledge-popup__textarea",placeholder:"請輸入知識庫描述",rows:"3",disabled:N.value},null,8,ze),[[H,V.value]])]),_("div",Pe,[_("label",null,I(p("knowledgeBaseFile")),1),_("div",Ve,[_("input",{type:"file",id:"knowledge-file",onChange:re,class:"knowledge-popup__file-input",multiple:"",disabled:N.value},null,40,Ue),_("label",{for:"knowledge-file",class:B(["knowledge-popup__file-label",{disabled:N.value}])},I(p("chooseFile")),3),_("span",Re,I(p("supportFileFormat")),1)])]),U.value.some((e=>!e.isFromKnowledgeBase))?(v(),C("div",Je,[_("label",null,I(p("uploadFileSequence"))+": "+I(U.value.filter((e=>!e.isFromKnowledgeBase)).length),1),_("ul",qe,[(v(!0),C(j,null,F(U.value.filter((e=>!e.isFromKnowledgeBase)),(e=>(v(),C("li",{key:e.id,class:"knowledge-popup__file-item"},[_("span",Ge,I(e.name),1),_("button",{class:"knowledge-popup__file-remove",onClick:a=>{return l=e.id,void(U.value=U.value.filter((e=>e.id!==l)));var l},disabled:N.value}," × ",8,Ne)])))),128))])])):M("",!0),U.value.some((e=>e.isFromKnowledgeBase))?(v(),C("div",We,[_("label",null,I(p("uploadedKnowledgeBaseFile"))+": "+I(U.value.filter((e=>e.isFromKnowledgeBase)).length),1),_("ul",Qe,[(v(!0),C(j,null,F(U.value.filter((e=>e.isFromKnowledgeBase)),(e=>(v(),C("li",{key:e.id,class:"knowledge-popup__file-item knowledge-popup__file-item--uploaded"},[_("span",Xe,I(e.name),1),_("span",Ye,I(p("uploaded")),1)])))),128))])])):M("",!0)]),_("div",Ze,[_("button",{class:"knowledge-popup__btn knowledge-popup__btn--cancel",onClick:de,disabled:N.value},I(N.value?p("canceling"):p("cancel")),9,ea),_("button",{class:"knowledge-popup__btn knowledge-popup__btn--confirm",onClick:pe,disabled:N.value},I(N.value?p("uploading"):p("confirm")),9,aa)])])])):M("",!0),X.value?(v(),C("div",la,[_("div",{class:"model-popup__overlay",onClick:ye}),_("div",ta,[_("div",sa,[_("h3",oa,I(p("modelSetting")),1),_("button",{class:"model-popup__close",onClick:ye},"×")]),_("div",na,[_("div",ia,[_("label",null,I(p("chooseModel")),1),K(_("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>Y.value=e),class:"model-popup__select"},[(v(!0),C(j,null,F(Z.value,(e=>(v(),C("option",{key:e.id,value:e.id,selected:e.id===Y.value},I(e.display_name||e.model),9,ca)))),128))],512),[[A,Y.value]]),we.value?(v(),C("div",da,I(we.value),1)):M("",!0),he.value?(v(),C("div",ua,[_("div",ra,I(p("currentModel"))+":",1),_("div",pa,I(ke.value),1)])):M("",!0)])]),_("div",ga,[_("button",{class:"model-popup__btn model-popup__btn--cancel",onClick:ye},I(p("cancel")),1),_("button",{class:"model-popup__btn model-popup__btn--confirm",onClick:_e,disabled:!Y.value},I(p("confirm")),9,va)])])])):M("",!0)],64))}}),[["__scopeId","data-v-83bc8f65"]]),_a={class:"wrap"},ha={key:0,class:"loading-container"},wa={key:1,class:"error-container"},ka={key:2,class:"chat-container"},ya={class:"chat-input-container"},fa=t(Object.assign({name:"對話頁面"},{__name:"ChatView",setup(l){const{t:t}=z(),s=e=>t(`main.${e}`),n=e(),i=a(),c=o(),d=k(!0),u=k(!1),g=k(!1),m=k(!1),h=k(null),w=k(null),y=()=>{h.value&&h.value.toggleSider()},B=(e=!0)=>{w.value&&w.value.scrollToBottom(e)},x=async e=>{try{c.chatHistory.some((a=>a.id==e))?(c.loadChat(parseInt(e)),d.value=!1,await L(),setTimeout((()=>{B(!1)}),300)):i.push("/")}catch(a){u.value=!0,d.value=!1}},M=async e=>{g.value=!0,setTimeout((()=>{B()}),100)},j=e=>{g.value=e,m.value=e,e||setTimeout((()=>{B()}),300)};return b((()=>n.params.id),(e=>{var a;e&&e!==(null==(a=c.currentChatId)?void 0:a.toString())&&(d.value=!0,x(e))})),b((()=>c.messages.length),((e,a)=>{e>a&&setTimeout((()=>{B()}),100)})),$((()=>{const e=n.params.id;x(e)})),f((()=>{setTimeout((()=>{B(!1)}),500)})),(e,a)=>(v(),C("div",_a,[T(r,{ref_key:"sidebarRef",ref:h},null,512),d.value?(v(),C("div",ha,[a[1]||(a[1]=_("div",{class:"loading-spinner"},null,-1)),_("p",null,I(s("loading")),1)])):u.value?(v(),C("div",wa,[a[2]||(a[2]=_("div",{class:"error-icon"},"⚠️",-1)),_("h3",null,I(s("error")),1),_("p",null,I(s("error_message")),1),_("button",{onClick:a[0]||(a[0]=e=>S(i).push("/")),class:"error-button"},I(s("back_to_home")),1)])):(v(),C("div",ka,[T(ma,{onToggleSidebar:y}),T(fe,{ref_key:"chatComponent",ref:w,"is-ai-loading":m.value},null,8,["is-ai-loading"]),_("div",ya,[T(p,{onProcessingStateChange:j,onMessageSubmit:M,"is-loading":g.value},null,8,["is-loading"])])]))]))}}),[["__scopeId","data-v-ed38d796"]]);export{fa as default};
