<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Firebase Cloud Messaging Example</title>
		<link rel="manifest" href="./manifest.json" />
	</head>
	<body>
		<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
			<button id="sub">訂閱</button>
			<div id="token"></div>
		</div>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
		<script>
			const firebaseConfig = {
				apiKey: "AIzaSyATDnYgGrq-D_C3Q8-q67a89rYjaSq_z5A",
				authDomain: "learn-for-web-push-a81dd.firebaseapp.com",
				projectId: "learn-for-web-push-a81dd",
				storageBucket: "learn-for-web-push-a81dd.appspot.com",
				messagingSenderId: "5848025284",
				appId: "1:5848025284:web:f2444f656e68836eeb6191"
			};
			firebase.initializeApp(firebaseConfig);

			const db = firebase.firestore();
			const messaging = firebase.messaging();
			const vapidKey = "BEFSzyy5-c8ygxcHHJCS76m38DjE0Z6Xf7NtpSCh2RM_AmkCo-GohGL0m6L9vPx9bn3MLKe5WaF2BJzGR3cqEYA";
			if ("serviceWorker" in navigator) {
				navigator.serviceWorker
					.register("./firebase-messaging-sw.js")
					.then((reg) => console.log("完成 SW 設定!", reg))
					.catch((err) => console.log("Error!", err));
			}
			function requestPermission() {
				console.log("Requesting permission...");
				Notification.requestPermission().then((permission) => {
					if (permission === "granted") {
						console.log("Notification permission granted.");
						resetUI();
					} else {
						console.log("Unable to get permission to notify.");
					}
				});
			}
			//取得token
			function resetUI() {
				messaging
					.getToken({ vapidKey: vapidKey })
					.then((currentToken) => {
						if (currentToken) {
							const tokenElement = document.querySelector("#token");
							tokenElement.textContent = currentToken;
						} else {
							console.log("No registration token available. Request permission to generate one.");
						}
					})
					.catch((err) => {
						console.log("An error occurred while retrieving token. ", err);
					});
			}
			document.querySelector("#sub").addEventListener("click", function () {
				requestPermission();
			});
		</script>
	</body>
</html>
