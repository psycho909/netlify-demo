<!DOCTYPE html>
<html lang="zh-Hant-TW">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PWA DEMO</title>
		<link rel="manifest" href="./manifest.json" />
		<script src="https://tw.hicdn.beanfun.com/plugins/vconsole/3.10.0/vconsole.min.js"></script>
	</head>
	<body>
		<div id="text"></div>
		<button id="notifications">通知開啟</button>
		<script>
			setTimeout(() => {
				fetch("https://jsonplaceholder.typicode.com/todos/1")
					.then((response) => response.json())
					.then((json) => (document.querySelector("#text").innerHTML = json.title));
			}, 5000);

			var vConsole = new VConsole();
			// manifest.json 可以在新增在主畫面上的類似app的網頁

			// 先產生PublicKey
			const applicationServerPublicKey = `BBHEOQlx7PZJoHYSllCL8hEax2QMNCV82zTTwerVEo9UD5gm5q9r37U5jMdGVDbkm-Y4ZX7XVy0GOuuLK0uK_g8`;
			const button = document.getElementById("notifications");
			button.addEventListener("click", () => {
				Notification.requestPermission().then((result) => {
					if (result === "granted") {
						console.log("開啟通知");
						// randomNotification();
					}
				});
			});
			Notification.requestPermission().then((result) => {
				if (result === "granted") {
					console.log("開啟通知");
					// randomNotification();
				}
			});
			// 註冊service worker
			navigator.serviceWorker
				.register("./sw.js")
				.then((reg) => {
					console.log("[Service Worker] registered!", reg);
					if ("Notification" in window) {
						// 判斷用戶推播狀態
						if (Notification.permission === "granted") {
							console.log("已經開啟通知");
							subscribeUser(reg);
							// navigator.setAppBadge(12);
						} else {
							console.log("還沒開啟通知");
							Notification.requestPermission().then((result) => {
								console.log("準備開啟通知");
								if (result === "granted") {
									console.log("開啟通知");
									subscribeUser(reg);
									// navigator.setAppBadge(12);
									// randomNotification();
								}
							});
							// Notification.requestPermission(function (status) {
							// 	console.log("Notification permission status:", status);
							// 	if (status === "granted") {
							// 		console.log("開啟通知");
							// 		subscribeUser(reg);
							// 		navigator.setAppBadge(12);
							// 	}
							// });
						}
					}

					console.log("[Service Worker] register end");
					if ("PushManager" in window) {
						console.log("支持web push api");
						// iOS mobile Safari supports Web Push API
					} else {
						// iOS mobile Safari does not support Web Push API
						console.log("沒有支持web push api");
					}
				})
				.catch((err) => console.log("Boo!", err));
			navigator.serviceWorker.getRegistration().then((res) => {
				console.log("[Service Worker] getRegistration", res);
			});

			navigator.serviceWorker.ready.then((registration) => {
				console.log("[Service Worker] ready");
				console.log(registration.getNotifications);
				if (registration.getNotifications) {
					registration.getNotifications().then((notifications) => {
						// do something with your notifications
						if (notifications.length == 0) {
							navigator.setAppBadge(0);
						}
						console.log("[Service Worker] getNotifications", notifications);
					});
				}
			});

			// PublicKey轉碼用
			function urlB64ToUint8Array(base64String) {
				const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
				const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");

				const rawData = window.atob(base64);
				const outputArray = new Uint8Array(rawData.length);

				for (let i = 0; i < rawData.length; ++i) {
					outputArray[i] = rawData.charCodeAt(i);
				}
				return outputArray;
			}

			// 用戶推播
			function subscribeUser(swRegistration) {
				let applicationServerKey;
				applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
				swRegistration.pushManager
					.subscribe({
						userVisibleOnly: true, // 送出去的訊息，指有此訂閱戶可以看到
						applicationServerKey: applicationServerKey
					})
					.then((subscription) => {
						console.log("User is subscribed");
						console.log(JSON.stringify(subscription));
					})
					.catch((err) => {
						console.log("Failed to subscribe the user: ", err);
					});
			}
		</script>
	</body>
</html>
