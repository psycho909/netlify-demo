<!DOCTYPE html>
<html lang="zh-Hant-TW">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="manifest" href="./manifest.json" />
		<script src="https://tw.hicdn.beanfun.com/plugins/vconsole/3.10.0/vconsole.min.js"></script>
		<style>
			img {
				width: 100px;
			}
		</style>
	</head>
	<body>
		<div id="text"></div>
		<button type="button" id="foo">按鈕</button>
		<script>
			setTimeout(() => {
				fetch("https://jsonplaceholder.typicode.com/todos/1")
					.then((response) => response.json())
					.then((json) => (document.querySelector("#text").innerHTML = json.title));
			}, 5000);

			var vConsole = new VConsole();
			const applicationServerPublicKey = `BBHEOQlx7PZJoHYSllCL8hEax2QMNCV82zTTwerVEo9UD5gm5q9r37U5jMdGVDbkm-Y4ZX7XVy0GOuuLK0uK_g8`;
			navigator.serviceWorker
				.register("./sw.js")
				.then((reg) => {
					console.log("[Service Worker] registered!", reg);
					if ("Notification" in window) {
						if (Notification.permission === "granted") {
							subscribeUser(reg);
						} else {
							Notification.requestPermission(function (status) {
								console.log("Notification permission status:", status);
								if (status === "granted") {
									subscribeUser(reg);
									navigator.setAppBadge(12);
								}
								// displayNotification();
							});
						}
					}

					console.log("[Service Worker] register end");
					if ("PushManager" in window) {
						console.log("支持web push api");
						// iOS mobile Safari supports Web Push API
					} else {
						// iOS mobile Safari does not support Web Push API
						console.log("沒有支持web push api");
					}
				})
				.catch((err) => console.log("Boo!", err));
			navigator.serviceWorker.getRegistration().then((res) => {
				console.log(res);
			});

			const options = { tag: "user_alerts" };
			navigator.serviceWorker.ready.then((registration) => {
				console.log("ready");
				registration.getNotifications(options).then((notifications) => {
					// do something with your notifications
					console.log("getNotifications", notifications);
				});
			});
			function urlB64ToUint8Array(base64String) {
				const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
				const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");

				const rawData = window.atob(base64);
				const outputArray = new Uint8Array(rawData.length);

				for (let i = 0; i < rawData.length; ++i) {
					outputArray[i] = rawData.charCodeAt(i);
				}
				return outputArray;
			}
			const isIosSafari = () => {
				const userAgent = window.navigator.userAgent.toLowerCase();
				return /iphone|ipad|ipod/.test(userAgent) && /safari/.test(userAgent) && !/chrome/.test(userAgent) && !/crios/.test(userAgent);
			};
			function subscribeUser(swRegistration) {
				let applicationServerKey;
				if (isIosSafari) {
					// applicationServerKey = applicationServerPublicKey;
					applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
				} else {
					applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
				}
				swRegistration.pushManager
					.subscribe({
						userVisibleOnly: true,
						applicationServerKey: applicationServerKey
					})
					.then((subscription) => {
						console.log("User is subscribed");
						console.log(JSON.stringify(subscription));
					})
					.catch((err) => {
						console.log("Failed to subscribe the user: ", err);
					});
			}
			var p = document.getElementById("foo");
			p.onclick = function () {
				// Ensure that the user can receive Safari Push Notifications.
				if ("safari" in window && "pushNotification" in window.safari) {
					console.log("In");
				} else {
					console.log("out");
				}
			};
		</script>
	</body>
</html>
